<!DOCTYPE html>
<html lang="es">
<head>
Â  <meta charset="UTF-8">
Â  <title>Buscador de Rutas SIP (Google Sheets)</title>
Â  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f4f4f4;
    }
    input, button {
      padding: 8px;
      margin: 5px;
    }
  </style>
</head>
<body>

<h2>ðŸ”Ž Buscador de Rutas SIP desde Google Sheets</h2>

<label>URL pÃºblica del Google Sheet (en formato CSV):</label><br>
<h4>https://docs.google.com/spreadsheets/d/1bE_Ozvob2p1hdYi9yuyi1ijkBmwsZxETdzhASQtQnoI/export?format=csv&gid=0</h4>
<input type="text" id="urlCsv" placeholder="https://docs.google.com/spreadsheets/d/1bE_Ozvob2p1hdYi9yuyi1ijkBmwsZxETdzhASQtQnoI/export?format=csv&gid=0" size="80"><br><br>

<label>Nombre(s) de Ruta SIP (separados por coma):</label><br>
<input type="text" id="nombresRuta" placeholder="Ruta1, Ruta2, Ruta3" size="80"><br><br>

<button id="botonBuscar">Buscar</button>

<div id="resultadoTabla"></div>

<script>
/**
 * FunciÃ³n principal para buscar rutas SIP en un Google Sheets publicado como CSV.
 * TambiÃ©n actualiza la URL con el tÃ©rmino de bÃºsqueda.
 */
async function buscar(actualizarUrl = true) { // AÃ±ade un parÃ¡metro para controlar si se actualiza la URL
  const urlCsv = document.getElementById('urlCsv').value.trim();
  const nombresTexto = document.getElementById('nombresRuta').value.trim();

  if (!urlCsv || !nombresTexto) {
    alert('Por favor, completa la URL del CSV y los nombres de las rutas.');
    return;
  }

  const nombresArray = nombresTexto.split(',').map(nombre => nombre.trim()).filter(nombre => nombre !== '');

  // Actualizar la URL con el tÃ©rmino de bÃºsqueda
  if (actualizarUrl) {
    const nuevaUrl = new URL(window.location.href);
    nuevaUrl.searchParams.set('q', nombresTexto); // 'q' es el parÃ¡metro para la bÃºsqueda
    window.history.pushState({ path: nuevaUrl.href }, '', nuevaUrl.href); // Sin recargar la pÃ¡gina
  }

  const resultados = await buscarRutasSIPDesdeGoogleSheet(urlCsv, nombresArray);
  mostrarResultadosEnTabla(resultados, 'resultadoTabla');
}

/**
 * Descarga y busca rutas SIP en un archivo CSV de Google Sheets.
 */
async function buscarRutasSIPDesdeGoogleSheet(urlCsv, nombresRutaSIP) {
  try {
    const response = await fetch(urlCsv);
    if (!response.ok) throw new Error(`No se pudo descargar el archivo. CÃ³digo de estado: ${response.status}`);

    const textoCsv = await response.text();
    const filas = textoCsv.split('\n').map(fila => fila.split(','));

    // Limpiar encabezados y quitar comillas
    const encabezados = filas[0].map(h => h.trim().replace(/^"|"$/g, ''));
    const data = filas.slice(1).map(fila => {
      const objeto = {};
      fila.forEach((valor, idx) => {
        if (encabezados[idx]) { // AsegÃºrate de que el encabezado exista
          objeto[encabezados[idx]] = valor.trim().replace(/^"|"$/g, '');
        }
      });
      return objeto;
    });

    // --- CONSOLE.LOG ADICIONALES (para depuraciÃ³n) ---
    console.log('--- NOMBRES DE RUTA SIP RECIBIDOS DEL CSV ---');
    console.log('Encabezados detectados del CSV:', encabezados);
    const todosLosNombresSIP = data.map(row => row['NOMBRE DE RUTA SIP']).filter(Boolean);
    if (todosLosNombresSIP.length > 0) {
      console.log(todosLosNombresSIP);
    } else {
      console.log('No se encontraron nombres de ruta SIP en el CSV (quizÃ¡s la columna no existe o estÃ¡ vacÃ­a despuÃ©s del parsing).');
    }
    console.log('-------------------------------------------');
    // --- FIN DE LOS CONSOLE.LOG ADICIONALES ---

    const nombres = Array.isArray(nombresRutaSIP) ? nombresRutaSIP : [nombresRutaSIP];

    const resultados = data.filter(row => {
      const nombreRuta = (row['NOMBRE DE RUTA SIP'] || '').toLowerCase();
      return nombres.some(nombre => nombreRuta.includes(nombre.toLowerCase()));
    });

    // --- CONSOLE.LOG PARA RESULTADOS FILTRADOS (para depuraciÃ³n) ---
    console.log('--- NOMBRES DE RUTA SIP FILTRADOS POR LA BÃšSQUEDA ---');
    if (resultados.length > 0) {
      const nombresFiltradosSIP = resultados.map(row => row['NOMBRE DE RUTA SIP']);
      console.log(nombresFiltradosSIP);
    } else {
      console.log('No se encontraron rutas SIP que coincidan con la bÃºsqueda.');
      console.log('TÃ©rminos de bÃºsqueda:', nombresRutaSIP);
    }
    console.log('----------------------------------------------------');
    // --- FIN CONSOLE.LOG PARA RESULTADOS FILTRADOS ---

    return resultados;

  } catch (error) {
    console.error('Error al procesar el CSV:', error);
    return [];
  }
}

/**
 * Muestra los resultados en una tabla HTML.
 */
function mostrarResultadosEnTabla(resultados, contenedorId) {
  const contenedor = document.getElementById(contenedorId);
  if (!contenedor) {
    console.error(`Contenedor con ID "${contenedorId}" no encontrado.`);
    return;
  }

  if (!resultados || resultados.length === 0) {
    contenedor.innerHTML = '<p>No se encontraron resultados.</p>';
    return;
  }

  const tabla = document.createElement('table');
  const thead = tabla.createTHead();
  const encabezados = ['NOMBRE DE RUTA SIP', 'OPERADOR', 'SBC TELECOM', 'DESCRIPCION', 'ASIGNACION SBC TELECOM', 'Status'];
  const filaEncabezado = thead.insertRow();
  encabezados.forEach(texto => {
    const th = document.createElement('th');
    th.textContent = texto;
    filaEncabezado.appendChild(th);
  });

  const tbody = tabla.createTBody();
  resultados.forEach(resultado => {
    const fila = tbody.insertRow();
    fila.insertCell().textContent = resultado['NOMBRE DE RUTA SIP'] || '';
    fila.insertCell().textContent = resultado['OPERADOR'] || '';
    fila.insertCell().textContent = resultado['SBC TELECOM'] || '';
    fila.insertCell().textContent = resultado['DESCRIPCION'] || '';
    fila.insertCell().textContent = resultado['ASIGNACION SBC TELECOM'] || '';
    fila.insertCell().textContent = resultado['Status'] || '';
  });

  contenedor.innerHTML = '';
  contenedor.appendChild(tabla);
}

/**
 * FunciÃ³n para obtener un parÃ¡metro de consulta de la URL.
 */
function getQueryParam(name) {
  const urlParams = new URLSearchParams(window.location.search);
  return urlParams.get(name);
}

// Conectar el botÃ³n al evento de bÃºsqueda
document.getElementById('botonBuscar').addEventListener('click', () => buscar(true)); // Siempre actualiza la URL al hacer clic

// Ejecutar la bÃºsqueda al cargar la pÃ¡gina si hay un tÃ©rmino en la URL
document.addEventListener('DOMContentLoaded', () => {
  const searchTerm = getQueryParam('q'); // Busca el parÃ¡metro 'q'
  if (searchTerm) {
    document.getElementById('nombresRuta').value = searchTerm; // Rellena el input
    buscar(false); // Ejecuta la bÃºsqueda, pero NO actualiza la URL de nuevo
  }
});
</script>

</body>
</html>